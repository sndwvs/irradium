# Description: The GNU Compiler Collection
# URL: https://gcc.gnu.org
# Maintainer: CRUX System Team, core-ports at crux dot nu
# Depends on: libgmp libmpc libmpfr zlib zstd

name=gcc
version=14.1.0
release=1
source=(https://sourceware.org/pub/gcc/releases/gcc-$version/$name-$version.tar.xz
    $name-4.7.3-multilib-dirs.patch
    $name-aarch64-disable-multilib-support.patch
    $name-riscv-disable-multilib-support.patch
    fix-nested-generic-lambda.patch
    $name-configure-Add-enable-autolink-libatomic-use-in-LINK_.patch
    $name-configure-fix-detection-of-atomic-builtins-in-libato.patch)

build() {
    patch -d $name-$version -p1 -i $SRC/$name-4.7.3-multilib-dirs.patch
    patch -d $name-$version -p1 -i $SRC/$name-aarch64-disable-multilib-support.patch
    patch -d $name-$version -p1 -i $SRC/$name-riscv-disable-multilib-support.patch
    patch -d $name-$version -p1 -i $SRC/fix-nested-generic-lambda.patch
    patch -d $name-$version -p1 -i $SRC/$name-configure-Add-enable-autolink-libatomic-use-in-LINK_.patch
    patch -d $name-$version -p1 -i $SRC/$name-configure-fix-detection-of-atomic-builtins-in-libato.patch

    [[ $(uname -m) == "riscv64" ]] && PKGMK_GCC+=' --enable-autolink-libatomic'

    # Credits @allanmcrae
    # https://github.com/allanmcrae/toolchain/blob/f18604d70c5933c31b51a320978711e4e6791cf1/gcc/PKGBUILD
    # TODO: properly deal with the build issues resulting from this
    CFLAGS=${CFLAGS/-Werror=format-security/}
    CXXFLAGS=${CXXFLAGS/-Werror=format-security/}

    # pipe fails tests
    #CFLAGS=${CFLAGS/-pipe/}
    #CXXFLAGS=${CXXFLAGS/-pipe/}

    mkdir build
    cd build
    ../$name-$version/configure $PKGMK_GCC \
        --prefix=/usr \
        --libexecdir=/usr/lib \
        --enable-threads=posix \
        --with-build-config=bootstrap-lto \
        --with-linker-hash-style=gnu \
        --with-system-zlib \
        --enable-languages=c,c++,lto \
        --enable-stage1-languages=c,lto \
        --enable-link-serialization=1 \
        --enable-linker-build-id \
        --enable-gnu-indirect-function \
        --enable-__cxa_atexit \
        --enable-clocale=gnu \
        --enable-shared \
        --enable-lto \
        --disable-multilib \
        --enable-plugin \
        --enable-default-pie \
        --enable-default-ssp \
        --enable-host-pie \
        --with-pkgversion="irradium $(getconf LONG_BIT)b" \
        --with-x=no \
        --disable-fixincludes \
        --disable-nls

    make -O STAGE1_CFLAGS="-O2" \
        BOOT_CFLAGS="$CFLAGS" \
        BOOT_LDFLAGS="$LDFLAGS" \
        LDFLAGS_FOR_TARGET="$LDFLAGS" \
        bootstrap
    make -j1 DESTDIR=$PKG install

    install -d $PKG/lib
    ln -sf ../usr/bin/cpp $PKG/lib/cpp
    ln -sf gcc $PKG/usr/bin/cc
    ln -sf g++ $PKG/usr/bin/c++

    rm -r $PKG/usr/share/{info,$name-$version}
    rm -r $PKG/usr/bin/*-linux-gnu*
    rm -r $PKG/usr/lib/gcc/*/$version/{install-tools,include-fixed}

    for D in lib{,32}; do
        install -d -m 0755 $PKG/usr/share/gdb/auto-load/usr/${D}
        mv $PKG/usr/${D}/libstdc++.so.*-gdb.py $PKG/usr/share/gdb/auto-load/usr/${D}
    done

    mkdir $PKG/usr/lib/bfd-plugins
    ln -sfv ../../lib/gcc/$($PKG/usr/bin/gcc -dumpmachine)/14.1.0/liblto_plugin.so \
        $PKG/usr/lib/bfd-plugins/

    sed -i "s|-L$SRC[^ ]* ||g" $PKG/usr/lib{,32}/{libstdc++.la,libsupc++.la}
}
